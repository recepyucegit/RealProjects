@model Domain.Entities.Sale
@{
    ViewData["Title"] = $"Satis Detay - {Model.SaleNumber}";
    var saleDetails = ViewBag.SaleDetails as IEnumerable<Domain.Entities.SaleDetail> ?? new List<Domain.Entities.SaleDetail>();
}

@* ===================================================================================
   TEKNOROMA - SATIŞ DETAY SAYFASI (FİŞ GÖRÜNTÜLEME)
   ===================================================================================

   Satış fişinin detaylarını gösteren sayfa.
   Müşteri bilgileri, ürün listesi, toplam tutar.

   =================================================================================== *@

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-receipt me-2"></i>Satis Fisi: <code>@Model.SaleNumber</code>
    </h1>
    <div>
        <a href="/Sales/Index" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-1"></i>Geri
        </a>
        @if (Model.Status == Domain.Enums.SaleStatus.Beklemede)
        {
            <form method="post" action="/Sales/Cancel" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <button type="submit" class="btn btn-danger" onclick="return confirm('Bu satisi iptal etmek istediginize emin misiniz?')">
                    <i class="bi bi-x-circle me-1"></i>Iptal Et
                </button>
            </form>
        }
        <button type="button" class="btn btn-primary" onclick="window.print()">
            <i class="bi bi-printer me-1"></i>Yazdir
        </button>
    </div>
</div>

<!-- Durum Badge -->
<div class="mb-4">
    @{
        var statusBadge = Model.Status switch
        {
            Domain.Enums.SaleStatus.Tamamlandi => "bg-success",
            Domain.Enums.SaleStatus.Beklemede => "bg-warning text-dark",
            Domain.Enums.SaleStatus.Hazirlaniyor => "bg-info",
            Domain.Enums.SaleStatus.Iptal => "bg-danger",
            _ => "bg-secondary"
        };

        var statusText = Model.Status switch
        {
            Domain.Enums.SaleStatus.Tamamlandi => "Tamamlandi",
            Domain.Enums.SaleStatus.Beklemede => "Beklemede",
            Domain.Enums.SaleStatus.Hazirlaniyor => "Hazirlaniyor",
            Domain.Enums.SaleStatus.Iptal => "Iptal Edildi",
            _ => "Bilinmiyor"
        };
    }
    <span class="badge @statusBadge fs-6">
        <i class="bi bi-circle-fill me-1"></i>@statusText
    </span>
</div>

<!-- Satis Bilgileri -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Satis Bilgileri</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <th width="40%">Fis No:</th>
                        <td><code>@Model.SaleNumber</code></td>
                    </tr>
                    <tr>
                        <th>Tarih:</th>
                        <td>@Model.SaleDate.ToString("dd.MM.yyyy HH:mm:ss")</td>
                    </tr>
                    <tr>
                        <th>Odeme Tipi:</th>
                        <td>
                            @{
                                var paymentText = Model.PaymentType switch
                                {
                                    Domain.Enums.PaymentType.Nakit => "Nakit",
                                    Domain.Enums.PaymentType.KrediKarti => "Kredi Karti",
                                    Domain.Enums.PaymentType.BankaHavalesi => "Banka Havalesi",
                                    _ => "Bilinmiyor"
                                };
                            }
                            <span class="badge bg-primary">@paymentText</span>
                        </td>
                    </tr>
                    <tr>
                        <th>Durum:</th>
                        <td>
                            <span class="badge @statusBadge">@statusText</span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Musteri ve Calisan</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <th width="40%">Musteri:</th>
                        <td>
                            @if (Model.Customer != null)
                            {
                                <div>
                                    <strong>@Model.Customer.FullName</strong><br>
                                    <small class="text-muted">@Model.Customer.Phone</small>
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">Kayitli degil</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <th>Calisan:</th>
                        <td>
                            @if (Model.Employee != null)
                            {
                                <strong>@Model.Employee.FullName</strong>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                    </tr>
                    @if (Model.Store != null)
                    {
                        <tr>
                            <th>Sube:</th>
                            <td>@Model.Store.Name</td>
                        </tr>
                    }
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Urun Listesi -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-transparent">
        <h5 class="mb-0"><i class="bi bi-cart me-2"></i>Satilan Urunler</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="50%">Urun</th>
                        <th class="text-end">Birim Fiyat</th>
                        <th class="text-center">Miktar</th>
                        <th class="text-end">Toplam</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var detail in saleDetails)
                    {
                        <tr>
                            <td>
                                <div>
                                    <strong>@detail.Product?.Name</strong>
                                    @if (!string.IsNullOrEmpty(detail.Product?.Barcode))
                                    {
                                        <br>
                                        <small class="text-muted">
                                            <code>@detail.Product.Barcode</code>
                                        </small>
                                    }
                                </div>
                            </td>
                            <td class="text-end">@detail.UnitPrice.ToString("N2") TL</td>
                            <td class="text-center">
                                <span class="badge bg-light text-dark">@detail.Quantity adet</span>
                            </td>
                            <td class="text-end fw-medium">@detail.Subtotal.ToString("N2") TL</td>
                        </tr>
                    }
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="3" class="text-end">TOPLAM:</th>
                        <th class="text-end text-success fs-5">@Model.TotalAmount.ToString("N2") TL</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Notlar (varsa) -->
@if (!string.IsNullOrWhiteSpace(Model.Notes))
{
    <div class="card shadow-sm">
        <div class="card-header bg-transparent">
            <h5 class="mb-0"><i class="bi bi-sticky me-2"></i>Notlar</h5>
        </div>
        <div class="card-body">
            <p class="mb-0">@Model.Notes</p>
        </div>
    </div>
}
