@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

@* ===================================================================================
   TEKNOROMA DASHBOARD
   ===================================================================================

   Ana sayfa - Ozet bilgiler ve hizli erisim.

   SENARYO (Haluk - Sube Muduru):
   Tek bakista subenin durumunu gorebilmeli:
   - Gunluk/aylik ciro
   - Kritik stok uyarilari
   - Bekleyen isler
   - Doviz kurlari

   =================================================================================== *@

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-speedometer2 me-2"></i>Dashboard
    </h1>
    <small class="text-muted">
        Son guncelleme: @Model.LastUpdated.ToString("dd.MM.yyyy HH:mm")
    </small>
</div>

<!-- Ozet Kartlari -->
<div class="row g-4 mb-4">
    <!-- Gunluk Satis -->
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                        <i class="bi bi-currency-lira"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Bugunun Cirosu</h6>
                        <h3 class="mb-0">@Model.TodaySalesTotal.ToString("N2") TL</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="/Sales" class="text-decoration-none small">
                    Detaylari gor <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Aylik Satis -->
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Aylik Ciro</h6>
                        <h3 class="mb-0">@Model.MonthlySalesTotal.ToString("N2") TL</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="/Reports/MonthlySales" class="text-decoration-none small">
                    Raporu gor <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Kritik Stok -->
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card h-100 @(Model.LowStockProductCount > 0 ? "border-warning" : "")">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3 position-relative">
                        <i class="bi bi-exclamation-triangle"></i>
                        @if (Model.LowStockProductCount > 0)
                        {
                            <span class="alert-badge badge bg-danger rounded-pill">!</span>
                        }
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Kritik Stok</h6>
                        <h3 class="mb-0">@Model.LowStockProductCount urun</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="/Products/LowStock" class="text-decoration-none small text-warning">
                    Hemen kontrol et <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Bekleyen Satislar -->
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card h-100 @(Model.PendingSalesCount > 0 ? "border-info" : "")">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-info bg-opacity-10 text-info me-3 position-relative">
                        <i class="bi bi-hourglass-split"></i>
                        @if (Model.PendingSalesCount > 0)
                        {
                            <span class="alert-badge badge bg-info rounded-pill">@Model.PendingSalesCount</span>
                        }
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Bekleyen Satis</h6>
                        <h3 class="mb-0">@Model.PendingSalesCount adet</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="/Sales/Pending" class="text-decoration-none small">
                    Depoya git <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Ikinci Satir -->
<div class="row g-4 mb-4">
    <!-- Teknik Servis -->
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card h-100 @(Model.OpenTicketsCount > 0 ? "border-danger" : "")">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-danger bg-opacity-10 text-danger me-3 position-relative">
                        <i class="bi bi-wrench"></i>
                        @if (Model.OpenTicketsCount > 0)
                        {
                            <span class="alert-badge badge bg-danger rounded-pill">@Model.OpenTicketsCount</span>
                        }
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Acik Talepler</h6>
                        <h3 class="mb-0">@Model.OpenTicketsCount adet</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="/TechnicalServices" class="text-decoration-none small">
                    Talepleri gor <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Odenmemis Giderler -->
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-secondary bg-opacity-10 text-secondary me-3">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Odenmemis Gider</h6>
                        <h3 class="mb-0">@Model.UnpaidExpensesCount adet</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0">
                <a href="/Expenses/Unpaid" class="text-decoration-none small">
                    Giderleri gor <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Doviz Kurlari -->
    <div class="col-xl-6 col-md-12">
        <div class="card stat-card h-100">
            <div class="card-body">
                <h6 class="text-muted mb-3">
                    <i class="bi bi-currency-exchange me-2"></i>Guncel Doviz Kurlari (TCMB)
                </h6>
                <div class="row">
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success me-2 fs-6">$</span>
                            <div>
                                <small class="text-muted d-block">USD/TRY</small>
                                <strong class="fs-4">@Model.UsdRate.ToString("N4")</strong>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-2 fs-6">â‚¬</span>
                            <div>
                                <small class="text-muted d-block">EUR/TRY</small>
                                <strong class="fs-4">@Model.EurRate.ToString("N4")</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grafikler Satiri -->
<div class="row g-4 mb-4">
    <!-- Haftalik Satis Grafigi -->
    <div class="col-xl-8 col-lg-7">
        <div class="card h-100">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>Son 7 Gun Satis Trendi
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary active" data-chart-type="line">Cizgi</button>
                    <button type="button" class="btn btn-outline-secondary" data-chart-type="bar">Cubuk</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="280"></canvas>
            </div>
        </div>
    </div>

    <!-- Kategori Dagilimi -->
    <div class="col-xl-4 col-lg-5">
        <div class="card h-100">
            <div class="card-header bg-transparent">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart me-2"></i>Kategori Dagilimi
                </h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="categoryChart" height="280"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Son Satislar ve Kritik Stok -->
<div class="row g-4 mb-4">
    <!-- Son Satislar -->
    <div class="col-xl-8 col-lg-7">
        <div class="card h-100">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-receipt me-2"></i>Son Satislar
                </h5>
                <a href="/Sales" class="btn btn-sm btn-outline-primary">Tumunu Gor</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Musteri</th>
                                <th>Tutar</th>
                                <th>Tarih</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.RecentSales.Any())
                            {
                                @foreach (var sale in Model.RecentSales)
                                {
                                    <tr>
                                        <td><a href="/Sales/Details/@sale.Id" class="text-primary">#@sale.Id</a></td>
                                        <td>@sale.CustomerName</td>
                                        <td class="fw-medium">@sale.Total.ToString("N2") TL</td>
                                        <td>@sale.Date.ToString("dd.MM HH:mm")</td>
                                        <td><span class="badge @sale.StatusClass">@sale.Status</span></td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        Henuz satis yapilmamis
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Kritik Stok Listesi -->
    <div class="col-xl-4 col-lg-5">
        <div class="card h-100">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Kritik Stok
                </h5>
                <a href="/Products/LowStock" class="btn btn-sm btn-outline-warning">Tumunu Gor</a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    @if (Model.LowStockProducts.Any())
                    {
                        @foreach (var product in Model.LowStockProducts.Take(5))
                        {
                            <a href="/Products/Edit/@product.Id" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">@product.ProductName</h6>
                                        <small class="text-muted">@product.CategoryName</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-danger">@product.CurrentStock adet</span>
                                        <small class="d-block text-muted">Min: @product.MinimumStock</small>
                                    </div>
                                </div>
                            </a>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-check-circle fs-1 text-success d-block mb-2"></i>
                            Kritik stok yok
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hizli Erisim -->
<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Hizli Islemler</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 col-6">
                        <a href="/Sales/Create" class="btn btn-outline-primary w-100 py-3">
                            <i class="bi bi-cart-plus d-block fs-3 mb-1"></i>
                            Yeni Satis
                        </a>
                    </div>
                    <div class="col-md-3 col-6">
                        <a href="/Products/Create" class="btn btn-outline-success w-100 py-3">
                            <i class="bi bi-box-seam d-block fs-3 mb-1"></i>
                            Yeni Urun
                        </a>
                    </div>
                    <div class="col-md-3 col-6">
                        <a href="/Customers/Create" class="btn btn-outline-info w-100 py-3">
                            <i class="bi bi-person-plus d-block fs-3 mb-1"></i>
                            Yeni Musteri
                        </a>
                    </div>
                    <div class="col-md-3 col-6">
                        <a href="/TechnicalServices/Create" class="btn btn-outline-warning w-100 py-3">
                            <i class="bi bi-wrench d-block fs-3 mb-1"></i>
                            Sorun Bildir
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // =========================================================================
    // DASHBOARD CHARTS - TeknoRoma
    // =========================================================================

    document.addEventListener('DOMContentLoaded', function() {
        // Chart.js varsayilan ayarlari
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#6c757d';

        // =====================================================================
        // HAFTALIK SATIS GRAFIGI
        // =====================================================================
        const salesCtx = document.getElementById('salesChart').getContext('2d');

        // Ornek veri - Gercek veri JSON ile gelecek
        const salesLabels = @Html.Raw(Json.Serialize(Model.Last7DaysSales.Select(x => x.Date)));
        const salesData = @Html.Raw(Json.Serialize(Model.Last7DaysSales.Select(x => x.Total)));
        const salesCount = @Html.Raw(Json.Serialize(Model.Last7DaysSales.Select(x => x.SaleCount)));

        // Eger veri yoksa ornek veri goster
        const defaultLabels = ['Pazartesi', 'Sali', 'Carsamba', 'Persembe', 'Cuma', 'Cumartesi', 'Pazar'];
        const defaultData = [12500, 18200, 15800, 22400, 19600, 28500, 24100];

        const chartLabels = salesLabels.length > 0 ? salesLabels : defaultLabels;
        const chartData = salesData.length > 0 ? salesData : defaultData;

        let salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Gunluk Ciro (TL)',
                    data: chartData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toLocaleString('tr-TR') + ' TL';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('tr-TR') + ' TL';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Grafik tipi degistirme
        document.querySelectorAll('[data-chart-type]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-chart-type]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const newType = this.dataset.chartType;
                salesChart.config.type = newType;
                salesChart.update();
            });
        });

        // =====================================================================
        // KATEGORI DAGILIMI PASTA GRAFIGI
        // =====================================================================
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');

        const categoryLabels = @Html.Raw(Json.Serialize(Model.CategorySales.Select(x => x.CategoryName)));
        const categoryData = @Html.Raw(Json.Serialize(Model.CategorySales.Select(x => x.Total)));

        // Eger veri yoksa ornek veri goster
        const defaultCatLabels = ['Telefon', 'Bilgisayar', 'Aksesuar', 'TV', 'Beyaz Esya'];
        const defaultCatData = [35, 25, 20, 12, 8];

        const catChartLabels = categoryLabels.length > 0 ? categoryLabels : defaultCatLabels;
        const catChartData = categoryData.length > 0 ? categoryData : defaultCatData;

        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: catChartLabels,
                datasets: [{
                    data: catChartData,
                    backgroundColor: [
                        '#667eea',
                        '#28a745',
                        '#17a2b8',
                        '#ffc107',
                        '#dc3545',
                        '#6c757d',
                        '#fd7e14'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return context.label + ': %' + percentage;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    });
</script>
}
