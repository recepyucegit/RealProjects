@model Domain.Entities.Product
@{
    ViewData["Title"] = "Urun Detay";
    var stockClass = Model.UnitsInStock <= 0 ? "bg-danger"
        : Model.UnitsInStock <= Model.CriticalStockLevel ? "bg-warning text-dark"
        : "bg-success";
    var statusClass = Model.IsActive ? "bg-success" : "bg-secondary";
}

@* ===================================================================================
   TEKNOROMA - URUN DETAY
   =================================================================================== *@

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-box-seam me-2"></i>@ViewData["Title"]
    </h1>
    <div>
        <a href="/Products/Edit/@Model.Id" class="btn btn-primary me-2">
            <i class="bi bi-pencil me-1"></i>Duzenle
        </a>
        <a href="/Products" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Geri Don
        </a>
    </div>
</div>

<div class="row">
    <!-- Sol Kolon - Urun Bilgileri -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Urun Bilgileri</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        @if (!string.IsNullOrEmpty(Model.ImageUrl))
                        {
                            <img src="@Model.ImageUrl" class="img-fluid rounded shadow-sm" style="max-height: 250px;" alt="@Model.Name">
                        }
                        else
                        {
                            <div class="bg-light rounded d-flex align-items-center justify-content-center mx-auto" style="width: 200px; height: 200px;">
                                <i class="bi bi-image text-muted" style="font-size: 4rem;"></i>
                            </div>
                        }
                        <div class="mt-3">
                            <span class="badge @statusClass fs-6">
                                @(Model.IsActive ? "Aktif" : "Pasif")
                            </span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h3 class="mb-3">@Model.Name</h3>
                        <p class="text-muted mb-4">@(Model.Description ?? "Aciklama bulunmuyor.")</p>

                        <table class="table table-borderless">
                            <tr>
                                <th class="text-muted" style="width: 40%;">Barkod:</th>
                                <td><code class="fs-5">@Model.Barcode</code></td>
                            </tr>
                            <tr>
                                <th class="text-muted">Kategori:</th>
                                <td>
                                    <span class="badge bg-light text-dark">
                                        <i class="bi bi-tag me-1"></i>@Model.Category?.Name
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Tedarikci:</th>
                                <td>
                                    <i class="bi bi-truck me-1"></i>@Model.Supplier?.CompanyName
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fiyat ve Stok Bilgileri -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0"><i class="bi bi-currency-lira me-2"></i>Fiyat Bilgisi</h5>
                    </div>
                    <div class="card-body text-center">
                        <h1 class="display-5 text-primary mb-2">
                            @Model.UnitPrice.ToString("N2")
                            <small class="fs-4">TL</small>
                        </h1>
                        <p class="text-muted mb-0">Birim Satis Fiyati (KDV Dahil)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0"><i class="bi bi-boxes me-2"></i>Stok Durumu</h5>
                    </div>
                    <div class="card-body text-center">
                        <h1 class="display-5 mb-2">
                            <span class="badge @stockClass fs-1">@Model.UnitsInStock</span>
                        </h1>
                        <p class="text-muted mb-2">Mevcut Stok (Adet)</p>
                        <small class="text-muted">
                            Kritik Seviye: <strong>@Model.CriticalStockLevel</strong> adet
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Satis Gecmisi -->
        <div class="card shadow-sm">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Son Satislar</h5>
                <a href="#" class="btn btn-sm btn-outline-primary">Tumunu Gor</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Satis No</th>
                                <th>Musteri</th>
                                <th>Miktar</th>
                                <th>Tutar</th>
                                <th>Tarih</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.SaleDetails?.Any() == true)
                            {
                                @foreach (var detail in Model.SaleDetails.OrderByDescending(d => d.Sale?.SaleDate).Take(5))
                                {
                                    <tr>
                                        <td>
                                            <a href="/Sales/Details/@detail.SaleId" class="text-primary">
                                                #@detail.SaleId
                                            </a>
                                        </td>
                                        <td>@detail.Sale?.Customer?.FirstName @detail.Sale?.Customer?.LastName</td>
                                        <td>@detail.Quantity adet</td>
                                        <td class="fw-medium">@detail.TotalAmount.ToString("N2") TL</td>
                                        <td>@detail.Sale?.SaleDate.ToString("dd.MM.yyyy HH:mm")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        Henuz satis yapilmamis
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sag Kolon - Hizli Islemler -->
    <div class="col-lg-4">
        <!-- Hizli Islemler -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Hizli Islemler</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/Products/Edit/@Model.Id" class="btn btn-primary">
                        <i class="bi bi-pencil me-2"></i>Urunu Duzenle
                    </a>
                    <a href="/Sales/Create?productId=@Model.Id" class="btn btn-success">
                        <i class="bi bi-cart-plus me-2"></i>Satis Yap
                    </a>
                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#stockModal">
                        <i class="bi bi-boxes me-2"></i>Stok Guncelle
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="btnDelete">
                        <i class="bi bi-trash me-2"></i>Urunu Sil
                    </button>
                </div>
            </div>
        </div>

        <!-- Istatistikler -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Istatistikler</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Toplam Satis Adedi:</span>
                    <strong>@(Model.SaleDetails?.Sum(d => d.Quantity) ?? 0) adet</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Toplam Satis Tutari:</span>
                    <strong>@((Model.SaleDetails?.Sum(d => d.TotalAmount) ?? 0).ToString("N2")) TL</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Stok Degeri:</span>
                    <strong>@((Model.UnitsInStock * Model.UnitPrice).ToString("N2")) TL</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Olusturma Tarihi:</span>
                    <strong>@Model.CreatedDate.ToString("dd.MM.yyyy")</strong>
                </div>
                @if (Model.ModifiedDate.HasValue)
                {
                    <div class="d-flex justify-content-between mt-2">
                        <span class="text-muted">Son Guncelleme:</span>
                        <strong>@Model.ModifiedDate.Value.ToString("dd.MM.yyyy HH:mm")</strong>
                    </div>
                }
            </div>
        </div>

        <!-- QR Kod -->
        <div class="card shadow-sm">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-qr-code me-2"></i>Barkod</h5>
            </div>
            <div class="card-body text-center">
                <div class="bg-light p-3 rounded mb-3">
                    <code class="fs-3">@Model.Barcode</code>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="navigator.clipboard.writeText('@Model.Barcode'); TeknoRoma.toast('Barkod kopyalandi', 'success');">
                    <i class="bi bi-clipboard me-1"></i>Kopyala
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stok Guncelleme Modal -->
<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-boxes me-2"></i>Stok Guncelle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Mevcut Stok</label>
                    <input type="number" class="form-control" id="newStock" value="@Model.UnitsInStock" min="0">
                </div>
                <div class="alert alert-info small mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Kritik stok seviyesi: <strong>@Model.CriticalStockLevel</strong> adet
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Iptal</button>
                <button type="button" class="btn btn-primary" id="btnSaveStock">Kaydet</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function() {
        // Silme islemi
        $('#btnDelete').click(function() {
            TeknoRoma.confirm(
                'Urun Sil',
                '<strong>@Model.Name</strong> adli urunu silmek istediginize emin misiniz?<br><br>' +
                '<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Bu islem geri alinamaz!</span>',
                function() {
                    $.ajax({
                        url: '/Products/Delete/@Model.Id',
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(result) {
                            if (result.success) {
                                TeknoRoma.toast(result.message, 'success');
                                setTimeout(() => window.location.href = '/Products', 1000);
                            } else {
                                TeknoRoma.toast(result.message, 'error');
                            }
                        },
                        error: function() {
                            TeknoRoma.toast('Bir hata olustu.', 'error');
                        }
                    });
                }
            );
        });

        // Stok guncelleme
        $('#btnSaveStock').click(function() {
            var quantity = parseInt($('#newStock').val());

            if (isNaN(quantity) || quantity < 0) {
                TeknoRoma.toast('Gecersiz stok miktari.', 'error');
                return;
            }

            $.ajax({
                url: '/Products/UpdateStock/@Model.Id',
                type: 'POST',
                data: { quantity: quantity },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(result) {
                    if (result.success) {
                        TeknoRoma.toast(result.message, 'success');
                        $('#stockModal').modal('hide');
                        setTimeout(() => location.reload(), 500);
                    } else {
                        TeknoRoma.toast(result.message, 'error');
                    }
                },
                error: function() {
                    TeknoRoma.toast('Bir hata olustu.', 'error');
                }
            });
        });
    });
</script>
@Html.AntiForgeryToken()
}
